<UserControl
    x:Class="ChinChessClient.Views.OnlineChinChessView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:chinesechess="clr-namespace:ChinChessClient.Commands"
    xmlns:models="clr-namespace:ChinChessClient.Models"
    xmlns:prism="http://prismlibrary.com/"
    prism:ViewModelLocator.AutoWireViewModel="True"
    MyAttachProperty.IsElementFocused="True">

    <UserControl.Resources>
        <ResourceDictionary Source="/ChinChessClient;component/Resources/ChineseChess.xaml" />
    </UserControl.Resources>

    <UserControl.InputBindings>
        <KeyBinding
            Key="{Binding KeyGestureDic[重玩].SelectedKey}"
            Command="{Binding RePlayCommand}"
            Modifiers="{Binding KeyGestureDic[重玩].ModifierKey}" />

        <KeyBinding
            Key="{Binding KeyGestureDic[悔棋].SelectedKey}"
            Command="{Binding RevokeCommand}"
            Modifiers="{Binding KeyGestureDic[悔棋].ModifierKey}" />

        <KeyBinding
            Key="{Binding KeyGestureDic[棋盘换向].SelectedKey}"
            Command="{Binding SwitchDirectionCommand}"
            Modifiers="{Binding KeyGestureDic[棋盘换向].ModifierKey}" />

        <KeyBinding
            Key="{Binding KeyGestureDic[模拟].SelectedKey}"
            Command="{Binding MockCommand, FallbackValue={x:Null}}"
            Modifiers="{Binding KeyGestureDic[模拟].ModifierKey}" />

        <KeyBinding
            Key="{Binding KeyGestureDic[认输].SelectedKey}"
            Command="{Binding GiveUpCommand}"
            Modifiers="{Binding KeyGestureDic[认输].ModifierKey}" />

        <KeyBinding
            Key="{Binding KeyGestureDic[和棋].SelectedKey}"
            Command="{Binding HeQiCommand}"
            Modifiers="{Binding KeyGestureDic[和棋].ModifierKey}" />
    </UserControl.InputBindings>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="3*" />
            <ColumnDefinition Width="4*" />
            <ColumnDefinition Width="3*" />
        </Grid.ColumnDefinitions>

        <Border
            Grid.Column="0"
            Margin="5"
            Background="#88CCCCCC"
            CornerRadius="10">
            <ListBox
                VerticalAlignment="Bottom"
                HorizontalContentAlignment="Left"
                FontSize="16"
                ItemsSource="{Binding Records}"
                ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                VirtualizingPanel.IsVirtualizing="True">
                <ListBox.Resources>
                    <Style TargetType="TextBlock">
                        <Setter Property="Foreground" Value="Black" />

                        <Setter Property="TextWrapping" Value="Wrap" />

                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsRed}" Value="True">
                                <Setter Property="Foreground" Value="Red" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ListBox.Resources>
                <ListBox.ItemTemplate>
                    <DataTemplate DataType="{x:Type models:Record}">
                        <TextBlock Margin="0,3" Style="{StaticResource {x:Type TextBlock}}">
                            <TextBlock Text="{Binding Id}" />
                            )
                            <TextBlock Text="{Binding Time, StringFormat='MM-dd HH:mm:ss'}" />
                            <TextBlock Text="{Binding Name}" />
                            <TextBlock Style="{StaticResource {x:Type TextBlock}}" Text="{Binding Action}" />
                        </TextBlock>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Border>

        <Viewbox
            Grid.Column="1"
            Margin="0,5"
            VerticalAlignment="Top">
            <StackPanel>
                <DockPanel Height="80" Background="Red">
                    <StackPanel
                        Background="#2874A6"
                        DockPanel.Dock="Left"
                        Orientation="Horizontal">

                        <Border Margin="5">
                            <Grid>
                                <Image Source="../Resources/Images/默认头像.png" />

                                <TextBlock Style="{StaticResource Time_Txt}" Text="{Binding BlackSeconds}" />
                            </Grid>
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsRedRole}" Value="False">
                                            <Setter Property="BorderBrush" Value="White" />
                                            <Setter Property="BorderThickness" Value="3" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                        </Border>

                        <Ellipse x:Name="BlackUser" HorizontalAlignment="Left">
                            <Ellipse.Fill>
                                <ImageBrush ImageSource="../Resources/Pictures/黑将.png" />
                            </Ellipse.Fill>
                            <Ellipse.Style>
                                <Style BasedOn="{StaticResource ChineseChess_Signal}" TargetType="Ellipse">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsRedTurn}" Value="True">
                                            <Setter Property="Stroke" Value="Transparent" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Ellipse.Style>
                        </Ellipse>
                        <Popup
                            MyAttachProperty.IsAppearOnHovered="True"
                            Placement="Bottom"
                            PlacementTarget="{Binding ElementName=BlackUser}">
                            <Border
                                MinHeight="100"
                                Background="{StaticResource PopupBackground}"
                                CornerRadius="10">
                                <ListBox ItemTemplate="{StaticResource DeadChessDataTemplate}" ItemsSource="{Binding RedDeads}">
                                    <ListBox.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel Width="330" />
                                        </ItemsPanelTemplate>
                                    </ListBox.ItemsPanel>
                                </ListBox>
                            </Border>
                        </Popup>

                        <TextBlock
                            Margin="3"
                            FontSize="20"
                            Style="{StaticResource TextBlock_Theme}"
                            Text="{Binding BlackTimeSpan, FallbackValue=00:00:00}" />
                    </StackPanel>

                    <StackPanel
                        Background="#DC7633"
                        DockPanel.Dock="Right"
                        Orientation="Horizontal">
                        <TextBlock
                            Margin="3"
                            FontSize="20"
                            Style="{StaticResource TextBlock_Theme}"
                            Text="{Binding RedTimeSpan, FallbackValue=00:00:00}" />

                        <Ellipse
                            x:Name="RedUser"
                            Grid.Row="1"
                            Grid.Column="0">
                            <Ellipse.Fill>
                                <ImageBrush ImageSource="../Resources/Pictures/红帅.png" />
                            </Ellipse.Fill>
                            <Ellipse.Style>
                                <Style BasedOn="{StaticResource ChineseChess_Signal}" TargetType="Ellipse">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsRedTurn}" Value="False">
                                            <Setter Property="Stroke" Value="Transparent" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Ellipse.Style>
                        </Ellipse>
                        <Popup
                            MyAttachProperty.IsAppearOnHovered="True"
                            Placement="Bottom"
                            PlacementTarget="{Binding ElementName=RedUser}">
                            <Border
                                MinHeight="100"
                                Background="{StaticResource PopupBackground}"
                                CornerRadius="10">
                                <ListBox ItemTemplate="{StaticResource DeadChessDataTemplate}" ItemsSource="{Binding BlackDeads}">
                                    <ListBox.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel Width="330" />
                                        </ItemsPanelTemplate>
                                    </ListBox.ItemsPanel>
                                </ListBox>
                            </Border>
                        </Popup>

                        <Border Margin="5">
                            <Grid>
                                <Image Source="../Resources/Images/默认头像.png" />

                                <TextBlock Style="{StaticResource Time_Txt}" Text="{Binding RedSeconds}" />
                            </Grid>
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsRedRole}" Value="True">
                                            <Setter Property="BorderBrush" Value="White" />
                                            <Setter Property="BorderThickness" Value="3" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                        </Border>
                    </StackPanel>

                    <UniformGrid
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Columns="4"
                        DockPanel.Dock="Left">
                        <Button Style="{StaticResource SwitchDirectionButton}" />

                        <Button Style="{StaticResource RePlayButton}" />

                        <Button Style="{StaticResource CancelLastButton}" />

                        <Button IsEnabled="{Binding IsMock, FallbackValue=True, Converter={StaticResource OppositeBoolConverter}}" Style="{StaticResource MockButton}" />

                        <Button Style="{StaticResource GiveUpButton}" />

                        <Button Style="{StaticResource HeQiButton}" />
                    </UniformGrid>
                </DockPanel>

                <Grid Margin="0,5,0,0">
                    <Image Style="{StaticResource Image_ChessBack}" />

                    <Grid Background="#AA999999" Visibility="{Binding IsMock, Converter={StaticResource BoolToVisibleCollapsedConverter}, FallbackValue={x:Static Visibility.Collapsed}}" />

                    <ListBox
                        Padding="11"
                        ItemContainerStyle="{StaticResource ListBoxItem_General}"
                        ItemTemplate="{StaticResource Chess}"
                        ItemsSource="{Binding Datas}"
                        RenderTransformOrigin="0.5,0.5">
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Columns="9" Rows="10" />
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                        <ListBox.RenderTransform>
                            <RotateTransform Angle="{Binding DataContext.Angle, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                        </ListBox.RenderTransform>
                    </ListBox>

                    <Grid Background="#AA999999" Style="{StaticResource Element_Visible}">
                        <Button
                            FontSize="60"
                            Foreground="Gray"
                            Style="{StaticResource RePlayButton}" />
                    </Grid>

                    <Button
                        Padding="3"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Top"
                        Command="{Binding MockCommand, FallbackValue={x:Null}}"
                        Style="{StaticResource Button_Icon_Close}"
                        Visibility="{Binding IsMock, Converter={StaticResource BoolToVisibleCollapsedConverter}, FallbackValue={x:Static Visibility.Collapsed}}" />
                </Grid>
            </StackPanel>
        </Viewbox>

        <Border
            Grid.Column="2"
            Margin="5"
            Background="#88CCCCCC"
            CornerRadius="10">
            <ListBox
                VerticalAlignment="Bottom"
                HorizontalContentAlignment="Left"
                FontSize="30"
                ItemsSource="{Binding CommandStack}"
                ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                VirtualizingPanel.IsVirtualizing="True">
                <ListBox.Resources>
                    <Style TargetType="TextBlock">
                        <Setter Property="Foreground" Value="Black" />

                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsRed}" Value="True">
                                <Setter Property="Foreground" Value="Red" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ListBox.Resources>
                <ListBox.ItemTemplate>
                    <DataTemplate DataType="{x:Type chinesechess:MoveCommand}">
                        <TextBlock Style="{StaticResource {x:Type TextBlock}}">
                            <TextBlock Text="{Binding Index}" />
                            ]
                            (
                            <TextBlock Text="{Binding From.Row}" />
                            ,
                            <TextBlock Text="{Binding From.Column}" />
                            ) => (
                            <TextBlock Text="{Binding To.Row}" />
                            ,
                            <TextBlock Text="{Binding To.Column}" />
                            )
                        </TextBlock>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Border>

        <DialogMessagePopup />
    </Grid>
</UserControl>
