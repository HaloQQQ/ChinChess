<UserControl
    x:Class="ChinChessClient.Views.OfflineCustomView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:b="http://schemas.microsoft.com/xaml/behaviors"
    xmlns:chinesechess="clr-namespace:ChinChessClient.Commands"
    xmlns:contracts="clr-namespace:ChinChessClient.Contracts"
    xmlns:models="clr-namespace:ChinChessClient.Models"
    xmlns:prism="http://prismlibrary.com/"
    prism:ViewModelLocator.AutoWireViewModel="True">
    <UserControl.Resources>
        <ResourceDictionary Source="/ChinChessClient;component/Resources/ChineseChess.xaml" />
    </UserControl.Resources>

    <UserControl.InputBindings>
        <KeyBinding
            Key="{Binding KeyGestureDic[重玩].SelectedKey}"
            Command="{Binding RePlayCommand}"
            Modifiers="{Binding KeyGestureDic[重玩].ModifierKey}" />

        <KeyBinding
            Key="{Binding KeyGestureDic[悔棋].SelectedKey}"
            Command="{Binding RevokeCommand}"
            Modifiers="{Binding KeyGestureDic[悔棋].ModifierKey}" />

        <KeyBinding
            Key="{Binding KeyGestureDic[棋盘换向].SelectedKey}"
            Command="{Binding SwitchDirectionCommand}"
            Modifiers="{Binding KeyGestureDic[棋盘换向].ModifierKey}" />
    </UserControl.InputBindings>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="3*" />
            <ColumnDefinition Width="4*" />
            <ColumnDefinition Width="3*" />
        </Grid.ColumnDefinitions>

        <Border
            Grid.Column="0"
            Margin="5"
            Background="#88CCCCCC"
            CornerRadius="10">
            <ListBox
                VerticalAlignment="Bottom"
                HorizontalContentAlignment="Left"
                FontSize="16"
                ItemsSource="{Binding Records}"
                ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                VirtualizingPanel.IsVirtualizing="True">
                <ListBox.Resources>
                    <Style TargetType="TextBlock">
                        <Setter Property="Foreground" Value="Black" />

                        <Setter Property="TextWrapping" Value="Wrap" />

                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsRed}" Value="True">
                                <Setter Property="Foreground" Value="Red" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ListBox.Resources>
                <ListBox.ItemTemplate>
                    <DataTemplate DataType="{x:Type models:Record}">
                        <TextBlock Margin="0,3" Style="{StaticResource {x:Type TextBlock}}">
                            <TextBlock Text="{Binding Id}" />
                            )
                            <TextBlock Text="{Binding Time, StringFormat='MM-dd HH:mm:ss'}" />
                            <TextBlock Text="{Binding Name}" />
                            <TextBlock Style="{StaticResource {x:Type TextBlock}}" Text="{Binding Action}" />
                        </TextBlock>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Border>

        <Viewbox
            Grid.Column="1"
            Margin="0,5"
            VerticalAlignment="Top">
            <StackPanel>
                <Grid>
                    <DockPanel
                        Height="80"
                        Background="Red"
                        DockPanel.Dock="Top">
                        <StackPanel
                            Background="#2874A6"
                            DockPanel.Dock="Left"
                            Orientation="Horizontal">

                            <Image Margin="5" Source="../Resources/Images/默认头像.png" />

                            <Ellipse x:Name="BlackUser" HorizontalAlignment="Left">
                                <Ellipse.Fill>
                                    <ImageBrush ImageSource="../Resources/Pictures/黑将.png" />
                                </Ellipse.Fill>
                                <Ellipse.Style>
                                    <Style BasedOn="{StaticResource ChineseChess_Signal}" TargetType="Ellipse">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsRedTurn}" Value="True">
                                                <Setter Property="Stroke" Value="Transparent" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            <Popup
                                MyAttachProperty.IsAppearOnHovered="True"
                                Placement="Bottom"
                                PlacementTarget="{Binding ElementName=BlackUser}">
                                <Border
                                    MinHeight="100"
                                    Background="{StaticResource PopupBackground}"
                                    CornerRadius="10">
                                    <ListBox ItemTemplate="{StaticResource DeadChessDataTemplate}" ItemsSource="{Binding RedDeads}">
                                        <ListBox.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Width="330" />
                                            </ItemsPanelTemplate>
                                        </ListBox.ItemsPanel>
                                    </ListBox>
                                </Border>
                            </Popup>

                            <TextBlock
                                Margin="3"
                                FontSize="20"
                                Style="{StaticResource TextBlock_Theme}"
                                Text="{Binding BlackTimeSpan, FallbackValue=00:00:00}" />
                        </StackPanel>

                        <StackPanel
                            Background="#DC7633"
                            DockPanel.Dock="Right"
                            Orientation="Horizontal">
                            <TextBlock
                                Margin="3"
                                FontSize="20"
                                Style="{StaticResource TextBlock_Theme}"
                                Text="{Binding RedTimeSpan, FallbackValue=00:00:00}" />

                            <Ellipse
                                x:Name="RedUser"
                                Grid.Row="1"
                                Grid.Column="0">
                                <Ellipse.Fill>
                                    <ImageBrush ImageSource="../Resources/Pictures/红帅.png" />
                                </Ellipse.Fill>
                                <Ellipse.Style>
                                    <Style BasedOn="{StaticResource ChineseChess_Signal}" TargetType="Ellipse">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsRedTurn}" Value="False">
                                                <Setter Property="Stroke" Value="Transparent" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            <Popup
                                MyAttachProperty.IsAppearOnHovered="True"
                                Placement="Bottom"
                                PlacementTarget="{Binding ElementName=RedUser}">
                                <Border
                                    MinHeight="100"
                                    Background="{StaticResource PopupBackground}"
                                    CornerRadius="10">
                                    <ListBox ItemTemplate="{StaticResource DeadChessDataTemplate}" ItemsSource="{Binding BlackDeads}">
                                        <ListBox.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Width="330" />
                                            </ItemsPanelTemplate>
                                        </ListBox.ItemsPanel>
                                    </ListBox>
                                </Border>
                            </Popup>

                            <Image Margin="5" Source="../Resources/Images/默认头像.png" />
                        </StackPanel>

                        <WrapPanel
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            DockPanel.Dock="Left">
                            <Button Style="{StaticResource SwitchDirectionButton}" />

                            <Button Style="{StaticResource RePlayButton}" />

                            <Button Style="{StaticResource CancelLastButton}" />
                        </WrapPanel>
                    </DockPanel>

                    <Grid Visibility="{Binding IsCustomOver, Converter={StaticResource BoolToCollapsedVisibleConverter}}">
                        <ListBox Background="LightBlue" ItemsSource="{Binding TemplateDatas}">
                            <ListBox.ItemTemplate>
                                <DataTemplate DataType="{x:Type models:CustomChess}">
                                    <Grid>
                                        <Image
                                            Width="75"
                                            Height="75"
                                            Style="{StaticResource Image_ChessContent}" />

                                        <Border
                                            Width="30"
                                            Height="30"
                                            HorizontalAlignment="Right"
                                            VerticalAlignment="Bottom"
                                            Background="Red"
                                            CornerRadius="30">
                                            <TextBlock
                                                FontSize="30"
                                                Foreground="White"
                                                Text="{Binding Count}"
                                                TextAlignment="Center" />
                                        </Border>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                            <ListBox.ItemContainerStyle>
                                <Style BasedOn="{StaticResource ListBoxItem_SelectedBackground}" TargetType="ListBoxItem">
                                    <Setter Property="Cursor" Value="SizeAll" />

                                    <EventSetter Event="MouseMove" Handler="CustomChess_DragLeave" />

                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Count}" Value="0">
                                            <Setter Property="IsEnabled" Value="False" />
                                        </DataTrigger>
                                        <Trigger Property="IsEnabled" Value="False">
                                            <Setter Property="Cursor" Value="No" />
                                            <Setter Property="OpacityMask" Value="{StaticResource OpacityMask_HasNotUsed}" />
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <UniformGrid
                                        Width="540"
                                        Columns="7"
                                        Rows="2" />
                                </ItemsPanelTemplate>
                            </ListBox.ItemsPanel>
                        </ListBox>

                        <Button
                            Padding="3"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Top"
                            Command="{Binding CustomOverCommand}"
                            Style="{StaticResource Button_Icon_Close}" />
                    </Grid>
                </Grid>

                <Grid Margin="0,5,0,0">
                    <Image Style="{StaticResource Image_ChessBack}" />

                    <ListBox
                        Padding="11"
                        AllowDrop="True"
                        ItemTemplate="{StaticResource Chess}"
                        ItemsSource="{Binding Datas}"
                        RenderTransformOrigin="0.5,0.5">
                        <ListBox.ItemContainerStyle>
                            <Style BasedOn="{StaticResource ListBoxItem_General}" TargetType="ListBoxItem">
                                <Setter Property="AllowDrop" Value="True" />

                                <EventSetter Event="Drop" Handler="Chess_Drop" />
                                <EventSetter Event="MouseRightButtonUp" Handler="ChessRemove_MouseRightButtonUp" />
                            </Style>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Columns="9" Rows="10" />
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                        <ListBox.RenderTransform>
                            <RotateTransform Angle="{Binding DataContext.Angle, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                        </ListBox.RenderTransform>
                    </ListBox>

                    <Grid Background="#AA999999">
                        <Grid.Style>
                            <Style BasedOn="{StaticResource Element_Visible}" TargetType="Grid">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Status}" Value="{x:Static contracts:GameStatus.NotInitialized}">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Grid.Style>
                        <Button
                            FontSize="60"
                            Foreground="Gray"
                            Style="{StaticResource RePlayButton}" />
                    </Grid>
                </Grid>
            </StackPanel>
        </Viewbox>

        <Border
            Grid.Column="2"
            Margin="5"
            Background="#88CCCCCC"
            CornerRadius="10">
            <ListBox
                VerticalAlignment="Bottom"
                HorizontalContentAlignment="Left"
                FontSize="30"
                ItemsSource="{Binding CommandStack}"
                ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                VirtualizingPanel.IsVirtualizing="True">
                <ListBox.Resources>
                    <Style TargetType="TextBlock">
                        <Setter Property="Foreground" Value="Black" />

                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsRed}" Value="True">
                                <Setter Property="Foreground" Value="Red" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ListBox.Resources>
                <ListBox.ItemTemplate>
                    <DataTemplate DataType="{x:Type chinesechess:MoveCommand}">
                        <TextBlock Style="{StaticResource {x:Type TextBlock}}">
                            <TextBlock Text="{Binding Index}" />
                            ]
                            (
                            <TextBlock Text="{Binding From.Row}" />
                            ,
                            <TextBlock Text="{Binding From.Column}" />
                            ) => (
                            <TextBlock Text="{Binding To.Row}" />
                            ,
                            <TextBlock Text="{Binding To.Column}" />
                            )
                        </TextBlock>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Border>

        <DialogMessagePopup />
    </Grid>
</UserControl>
