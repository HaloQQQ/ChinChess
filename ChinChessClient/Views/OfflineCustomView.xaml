<UserControl
    x:Class="ChinChessClient.Views.OfflineCustomView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:b="http://schemas.microsoft.com/xaml/behaviors"
    xmlns:contracts="clr-namespace:ChinChessCore.Contracts;assembly=ChinChessCore"
    xmlns:coreModels="clr-namespace:ChinChessCore.Models;assembly=ChinChessCore"
    xmlns:prism="http://prismlibrary.com/"
    xmlns:usercontrols="clr-namespace:ChinChessClient.UserControls"
    prism:ViewModelLocator.AutoWireViewModel="True">
    <UserControl.Resources>
        <ResourceDictionary Source="/ChinChessClient;component/Resources/ChineseChess.xaml" />
    </UserControl.Resources>

    <UserControl.InputBindings>
        <KeyBinding
            Key="{Binding KeyGestureDic[重玩].SelectedKey}"
            Command="{Binding RePlayCommand}"
            Modifiers="{Binding KeyGestureDic[重玩].ModifierKey}" />

        <KeyBinding
            Key="{Binding KeyGestureDic[悔棋].SelectedKey}"
            Command="{Binding RevokeCommand}"
            Modifiers="{Binding KeyGestureDic[悔棋].ModifierKey}" />

        <KeyBinding
            Key="{Binding KeyGestureDic[棋盘换向].SelectedKey}"
            Command="{Binding SwitchDirectionCommand}"
            Modifiers="{Binding KeyGestureDic[棋盘换向].ModifierKey}" />
    </UserControl.InputBindings>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="3*" />
            <ColumnDefinition Width="4*" />
            <ColumnDefinition Width="3*" />
        </Grid.ColumnDefinitions>

        <usercontrols:RecordCtrl Grid.Column="0" />

        <Viewbox
            Grid.Column="1"
            Margin="0,5"
            VerticalAlignment="Top">
            <StackPanel>
                <Grid>
                    <DockPanel
                        Height="80"
                        Background="Red"
                        DockPanel.Dock="Top">
                        <StackPanel
                            Background="#2874A6"
                            DockPanel.Dock="Left"
                            Orientation="Horizontal">

                            <Image Margin="5" Source="../Resources/Images/默认头像.png" />

                            <Ellipse x:Name="BlackUser" HorizontalAlignment="Left">
                                <Ellipse.Fill>
                                    <ImageBrush ImageSource="../Resources/Pictures/黑将.png" />
                                </Ellipse.Fill>
                                <Ellipse.Style>
                                    <Style BasedOn="{StaticResource ChineseChess_Signal}" TargetType="Ellipse">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsRedTurn}" Value="True">
                                                <Setter Property="Stroke" Value="Transparent" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            <Popup
                                MyAttachProperty.IsAppearOnHovered="True"
                                Placement="Bottom"
                                PlacementTarget="{Binding ElementName=BlackUser}">
                                <Border
                                    MinHeight="100"
                                    Background="{StaticResource PopupBackground}"
                                    CornerRadius="10">
                                    <ListBox ItemTemplate="{StaticResource DeadChessDataTemplate}" ItemsSource="{Binding RedDeads}">
                                        <ListBox.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Width="330" />
                                            </ItemsPanelTemplate>
                                        </ListBox.ItemsPanel>
                                    </ListBox>
                                </Border>
                            </Popup>

                            <TextBlock
                                Margin="3"
                                FontSize="20"
                                Style="{StaticResource TextBlock_Theme}"
                                Text="{Binding BlackTimeSpan, FallbackValue=00:00:00}" />
                        </StackPanel>

                        <StackPanel
                            Background="#DC7633"
                            DockPanel.Dock="Right"
                            Orientation="Horizontal">
                            <TextBlock
                                Margin="3"
                                FontSize="20"
                                Style="{StaticResource TextBlock_Theme}"
                                Text="{Binding RedTimeSpan, FallbackValue=00:00:00}" />

                            <Ellipse
                                x:Name="RedUser"
                                Grid.Row="1"
                                Grid.Column="0">
                                <Ellipse.Fill>
                                    <ImageBrush ImageSource="../Resources/Pictures/红帅.png" />
                                </Ellipse.Fill>
                                <Ellipse.Style>
                                    <Style BasedOn="{StaticResource ChineseChess_Signal}" TargetType="Ellipse">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsRedTurn}" Value="False">
                                                <Setter Property="Stroke" Value="Transparent" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            <Popup
                                MyAttachProperty.IsAppearOnHovered="True"
                                Placement="Bottom"
                                PlacementTarget="{Binding ElementName=RedUser}">
                                <Border
                                    MinHeight="100"
                                    Background="{StaticResource PopupBackground}"
                                    CornerRadius="10">
                                    <ListBox ItemTemplate="{StaticResource DeadChessDataTemplate}" ItemsSource="{Binding BlackDeads}">
                                        <ListBox.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Width="330" />
                                            </ItemsPanelTemplate>
                                        </ListBox.ItemsPanel>
                                    </ListBox>
                                </Border>
                            </Popup>

                            <Image Margin="5" Source="../Resources/Images/默认头像.png" />
                        </StackPanel>

                        <WrapPanel
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            DockPanel.Dock="Left">
                            <Button Style="{StaticResource SwitchDirectionButton}" />

                            <Button Style="{StaticResource RePlayButton}" />

                            <Button Style="{StaticResource CancelLastButton}" />

                            <Button Command="{Binding ToggleRecordCommand}" ToolTip="记录步骤">
                                <Button.Style>
                                    <Style BasedOn="{StaticResource FunctionButton}" TargetType="Button">
                                        <Setter Property="FontFamily" Value="{StaticResource Iconfont}" />

                                        <Setter Property="Content" Value="&#xe64d;" />

                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsRecording}" Value="True">
                                                <Setter Property="Content" Value="&#xe615;" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </WrapPanel>
                    </DockPanel>

                    <Grid Visibility="{Binding IsCustomOver, Converter={StaticResource BoolToCollapsedVisibleConverter}}">
                        <ListBox Background="LightBlue" ItemsSource="{Binding TemplateDatas}">
                            <ListBox.ItemTemplate>
                                <DataTemplate DataType="{x:Type coreModels:CustomChess}">
                                    <Grid>
                                        <Image
                                            Width="75"
                                            Height="75"
                                            Style="{StaticResource Image_ChessContent}" />

                                        <Border
                                            Width="30"
                                            Height="30"
                                            HorizontalAlignment="Right"
                                            VerticalAlignment="Bottom"
                                            Background="Red"
                                            CornerRadius="30">
                                            <TextBlock
                                                FontSize="30"
                                                Foreground="White"
                                                Text="{Binding Count}"
                                                TextAlignment="Center" />
                                        </Border>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                            <ListBox.ItemContainerStyle>
                                <Style BasedOn="{StaticResource ListBoxItem_SelectedBackground}" TargetType="ListBoxItem">
                                    <Setter Property="Cursor" Value="SizeAll" />

                                    <EventSetter Event="MouseMove" Handler="CustomChess_DragLeave" />

                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Count}" Value="0">
                                            <Setter Property="IsEnabled" Value="False" />
                                        </DataTrigger>
                                        <Trigger Property="IsEnabled" Value="False">
                                            <Setter Property="Cursor" Value="No" />
                                            <Setter Property="OpacityMask" Value="{StaticResource OpacityMask_HasNotUsed}" />
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <UniformGrid
                                        Width="540"
                                        Columns="7"
                                        Rows="2" />
                                </ItemsPanelTemplate>
                            </ListBox.ItemsPanel>
                        </ListBox>

                        <StackPanel HorizontalAlignment="Right" VerticalAlignment="Top">
                            <Button
                                Padding="3"
                                Command="{Binding CustomOverCommand}"
                                FontSize="25"
                                Style="{StaticResource Button_Icon_Close}"
                                ToolTip="设计完成" />

                            <ToggleButton
                                Content="&#xe654;"
                                FontSize="30"
                                IsChecked="{Binding IsSaving}"
                                IsEnabled="{Binding IsSaving, Converter={StaticResource OppositeBoolConverter}}"
                                Style="{StaticResource ButtonBase_Icon_ScaleDown_Small_HoverBlue}"
                                ToolTip="保存布局" />
                            <Popup
                                IsOpen="{Binding IsSaving}"
                                Placement="Center"
                                PlacementTarget="{Binding RelativeSource={RelativeSource AncestorType=Window}}"
                                StaysOpen="True">
                                <Grid>
                                    <Border
                                        Width="600"
                                        Height="300"
                                        Background="{StaticResource PopupBackground}"
                                        CornerRadius="20">
                                        <StackPanel>
                                            <!--<TextBox
                                                Width="400"
                                                Height="80"
                                                FontSize="35"
                                                MyAttachProperty.IsCollapsed="True"
                                                MyAttachProperty.PlaceHolder="步骤"
                                                Style="{StaticResource TextBox_PlaceHolderAsLable_Execute}"
                                                Text="{Binding Steps, UpdateSourceTrigger=PropertyChanged, Delay=50}" />-->

                                            <TextBox
                                                Width="400"
                                                Height="80"
                                                FontSize="35"
                                                MyAttachProperty.Command="{Binding SaveDesignCommand}"
                                                MyAttachProperty.CommandParameter="{Binding DesignName}"
                                                MyAttachProperty.DoubleValue="35"
                                                MyAttachProperty.IconFontText="&#xe64f;"
                                                MyAttachProperty.PlaceHolder="残局名"
                                                Style="{StaticResource TextBox_PlaceHolderAsLable_Execute}"
                                                Text="{Binding DesignName, UpdateSourceTrigger=PropertyChanged, Delay=50}">
                                                <TextBox.InputBindings>
                                                    <KeyBinding
                                                        Key="Return"
                                                        Command="{Binding SaveDesignCommand}"
                                                        CommandParameter="{Binding DesignName}" />
                                                </TextBox.InputBindings>
                                            </TextBox>
                                        </StackPanel>
                                    </Border>

                                    <ToggleButton
                                        Padding="8"
                                        HorizontalAlignment="Right"
                                        VerticalAlignment="Top"
                                        Content="&#xe624;"
                                        FontSize="25"
                                        IsChecked="{Binding IsSaving}"
                                        Style="{StaticResource ButtonBase_Icon_ScaleUp_Small_HoverBlue}"
                                        ToolTip="取消" />
                                </Grid>
                            </Popup>
                        </StackPanel>
                    </Grid>
                </Grid>

                <Grid Margin="0,5,0,0">
                    <Image Style="{StaticResource Image_ChessBack}" />

                    <ListBox
                        Padding="11"
                        AllowDrop="True"
                        ItemTemplate="{StaticResource Chess}"
                        ItemsSource="{Binding Datas}"
                        RenderTransformOrigin="0.5,0.5">
                        <ListBox.ItemContainerStyle>
                            <Style BasedOn="{StaticResource ListBoxItem_General}" TargetType="ListBoxItem">
                                <Setter Property="AllowDrop" Value="True" />

                                <EventSetter Event="Drop" Handler="Chess_Drop" />
                                <EventSetter Event="MouseRightButtonUp" Handler="ChessRemove_MouseRightButtonUp" />
                            </Style>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Columns="9" Rows="10" />
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                        <ListBox.RenderTransform>
                            <RotateTransform Angle="{Binding DataContext.Angle, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                        </ListBox.RenderTransform>
                    </ListBox>

                    <Grid Background="#AA999999">
                        <Grid.Style>
                            <Style BasedOn="{StaticResource Element_Visible}" TargetType="Grid">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Status}" Value="{x:Static contracts:EnumGameStatus.NotInitialized}">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Grid.Style>
                        <Button
                            FontSize="60"
                            Foreground="Gray"
                            Style="{StaticResource RePlayButton}" />
                    </Grid>
                </Grid>
            </StackPanel>
        </Viewbox>

        <usercontrols:MovePahtCtrl Grid.Column="2" />

        <DialogMessagePopup />
    </Grid>
</UserControl>
